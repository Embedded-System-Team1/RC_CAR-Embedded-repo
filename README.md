### ğŸ¯ë²”ìš© RCì¹´ í”„ë¡œì íŠ¸ ì†Œê°œ

RC ì¹´ì˜ ì œì–´ì™€ ê¸°ê¸° ì¶”ê°€ë¥¼ ì¢€ ë” í™•ì¥í•˜ê¸° ì‰½ê²Œ í•˜ê¸° ìœ„í•´ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ í”„ë¡œì íŠ¸ëŠ” ì•„ë˜ì™€ ê°™ì€ ëª©ì ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤:

- **ëª¨í„° ë° ì œì–´ ì¥ì¹˜ í™•ì¥**: DC ëª¨í„°, ì„œë³´ ëª¨í„° ë“± ë‹¤ì–‘í•œ ì„ë² ë””ë“œ ì œì–´ ì¥ì¹˜ë¥¼ ì‰½ê²Œ ì¶”ê°€í•˜ê³ , ì‚¬ìš©ì ë§ì¶¤ ì œì–´ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•¨.
- **ì œì–´ ë°©ë²•ì˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•**: WebSocket API, Bluetooth ë“±ì„ í†µí•´ ì‚¬ìš©ìê°€ ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ RC ì¹´ë¥¼ ì œì–´í•  ìˆ˜ ìˆë„ë¡ ìœ ì—°ì„±ì„ ì œê³µ.
- **í™•ì¥ì„±ê³¼ ì•ˆì •ì„± ê°•í™”**: í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ê³¼ ë™ì‹œì„± ì œì–´ë¥¼ í†µí•´ ì•ˆì •ì ì´ë©° í™•ì¥ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ êµ¬ì¶•.


### ğŸ“Š ë²”ìš© RC ì¹´ í”„ë¡œì íŠ¸ êµ¬ì„±ë„
![image](https://github.com/user-attachments/assets/81e5fe47-def0-42ed-826a-f32e7bb2c866)
----
1. Controller
RC ì¹´ì˜ ë™ì‘ì„ ì œì–´í•˜ë©°, DC ëª¨í„°ì™€ ì„œë³´ ëª¨í„°ì˜ ì†ë„ ë° ë°©í–¥ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. Thread Poolì„ ì‚¬ìš©í•´ ë³‘ë ¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©°, íš¨ìœ¨ì ì¸ ë¦¬ì†ŒìŠ¤ í™œìš©ê³¼ ë¹ ë¥¸ ì‘ë‹µì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

2. Connection Handler
ì™¸ë¶€ ì…ë ¥(Bluetooth, WebSocket, Remote)ì„ ì²˜ë¦¬í•˜ë©°, ë™ì‹œ ì—°ê²° ì‹œ ê²½ìŸ ì¡°ê±´ ë°©ì§€ë¥¼ ìœ„í•´ Mutex Lockì„ ì‚¬ìš©í•´ ì•ˆì •ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

3. IPC (Message Queue)
í”„ë¡œì„¸ìŠ¤ ê°„ ë°ì´í„° êµí™˜ì„ ìœ„í•œ ë¹„ë™ê¸° ë°ì´í„° ì „ë‹¬ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë°ì´í„°ë¥¼ FIFO ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©°, Connection Handlerì™€ Controller ê°„ì˜ ì˜ì‚¬ì†Œí†µì„ ì¤‘ì¬í•©ë‹ˆë‹¤.

4. Thread Pool
Controllerì™€ Connection Handler ëª¨ë‘ì—ì„œ ì‘ì—…ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•˜ë©°, ë¦¬ì†ŒìŠ¤ ìµœì í™” ë° ì„±ëŠ¥ í–¥ìƒì„ ë„ëª¨í•©ë‹ˆë‹¤.

5. ì™¸ë¶€ ì œì–´ ì†Œí”„íŠ¸ì›¨ì–´
WebSocket APIì™€ Bluetooth ëª¨ë“ˆì„ í†µí•´ ì‚¬ìš©ìê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ RC ì¹´ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
----
ë™ì‹œì„± ì œì–´
- Mutex Lock: Connection Handlerì—ì„œ ë‹¤ì¤‘ ì—°ê²° ê²½ìŸ ì¡°ê±´ ë°©ì§€ë¥¼ ìœ„í•´ ì‚¬ìš©.
- Thread Pool: ë³‘ë ¬ ì‘ì—… ì²˜ë¦¬ë¡œ ìì› ì†Œëª¨ë¥¼ ìµœì†Œí™”í•˜ë©° ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ë†’ì„.
- Message Queue: ë¹„ë™ê¸° ë©”ì‹œì§€ ì „ë‹¬ë¡œ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ìœ ì§€í•¨.

---

### ğŸ› ï¸ì„ë² ë””ë“œ ì†Œí”„íŠ¸ì›¨ì–´ êµ¬ì„±
![image](https://github.com/user-attachments/assets/816f6019-7554-4db1-876e-a28754b435e0)

**1. main.c**
   í”„ë¡œê·¸ë¨ì˜ ì‹œì‘ì ì´ì root process
   
   í”„ë¡œê·¸ë¨ì´ ì‹œì‘ë˜ë©´ child process ë¡œ  
   controller.c ì™€ handler.cë¥¼ fork spawnì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

**2. handler.c**

   RCì¹´ë¥¼ ì§ì ‘ ì œì–´í•˜ê±°ë‚˜ ì›¹ í†µì‹  ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ë“±ë“±
   RCì¹´ ì œì–´ë¥¼ ìœ„í•œ connection ì„ í•¸ë“¤ë§ í•¨
   
   connectionì—ì„œ ë³´ë‚´ì§„ ë°ì´í„°ë¥¼ IPCë¡œ ë³´ë‚´ëŠ” íŒŒì´í”„ë¼ì¸ ì—­í• ì„ í•¨

**3. controller.c**

   ë©”ì„¸ì§€ íì˜ ë°ì´í„°ë¥¼ polling í•˜ì—¬ device ì¥ì¹˜ë¥¼ ì œì–´í•˜ë„ë¡ ì‹¤í–‰í•¨

**4. device_adaptor.c** 

   connectionì—ì„œ ë³´ë‚¸ ë°ì´í„°ë¥¼ parsing í•˜ì—¬ ì í•©í•œ device worker thread ì— ë™ì‘í•˜ê²Œ í•œë‹¤.
   device_adaptor ì— ì œê³µëœ ê·œì•…ì„ device ì‹¤í–‰ ë©”ì„œë“œì™€ êµ¬ì¡°ì²´ , ë¬¸ìì—´ êµ¬ì¡°ì²´ ë³€í™˜ ë©”ì„œë“œë¥¼ ì»¤ìŠ¤í…€í•˜ë©´
   í•´ë‹¹ deviceë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

**5. worker thread pool** 

   connection ê³¼ device ì œì–´ëŠ” ë¹„ë™ê¸° ì‹ ì‹¤í–‰ì„ ìœ„í•´ ë©€í‹° ìŠ¤ë ˆë”©ì„ ì±„íƒí•¨
   ì¥ì¹˜ ì œì–´ì™€ connection ì€ real time ìœ¼ë¡œ ì‘ì—…ì´ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì‘ì—… ë‹¨ìœ„ë§ˆë‹¤ threadë¥¼ ìƒì„±-ì¢…ë£Œ êµ¬ì¡°ëŠ” ë¹„ì í•©
   controller ì™€ handler í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œ thread ë¥¼ ìƒì„±í•´ë†“ê³  thread pool ë¡œ ì ì¬í•˜ì—¬ ë¦¬ì†ŒìŠ¤ë¥¼ íš¨ìœ¨í™” ì‹œí‚´

**6. concurrency control (connection multi thread)**

   connection ë¼ë¦¬ ë°ì´í„° ì „ì†¡ì—ì„œ í•œ ë©”ì‹œì§€ ë‹¨ìœ„ë¡œ ë™ê¸°í™”ê°€ ë³´ì¥ë˜ì–´ì•¼ í•œë‹¤.
   
   ê° connection ì˜ ë°ì´í„° ì „ì†¡ transaction ì˜ ë™ê¸°í™”ë¥¼ ë³´ì¥í•œë‹¤.
   
   handler.c ì—ì„œ mutex_lock ì„ ì´ìš©í•˜ì—¬ ë™ê¸°í™”ë¥¼ ë³´ì¥í•œë‹¤.

 



## ğŸ“ ì‹œìŠ¤í…œ ì»¤ìŠ¤í…€ ê°€ì´ë“œ

### device í™•ì¥ ê°€ì´ë“œ

---

### **ìƒˆë¡œìš´ ëª¨í„° íƒ€ì… ì¶”ê°€ ë°©ë²•**

ìƒˆë¡œìš´ ëª¨í„° íƒ€ì…ì„ ì¶”ê°€í•˜ë ¤ë©´ ë‹¤ìŒ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤:
1. **ëª…ë ¹ êµ¬ì¡°ì²´**ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.  
   - êµ¬ì¡°ì²´ì—ëŠ” **ë°˜ë“œì‹œ `id` í•„ë“œ**ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
   - json ë¬¸ìì—´ì„ êµ¬ì¡°ì²´ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
2. **ëª…ë ¹ ì²˜ë¦¬ í•¨ìˆ˜**ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
3. **ëª¨í„° í•¸ë“¤ëŸ¬**ë¥¼ í”„ë ˆì„ì›Œí¬ì— ë“±ë¡í•©ë‹ˆë‹¤.

---

### **ë‹¨ê³„ë³„ ê°€ì´ë“œ**
- í™•ì¥í•  device ê´€ë ¨ ì»¤ìŠ¤í…€ í•¨ìˆ˜ë¥¼ ì •ì˜í•  íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤ (ì´ë²ˆ ì˜ˆì‹œëŠ” survo.c ì„ ìƒì„±í–ˆë‹¤ê³  ê°€ì •)

#### **1. ëª…ë ¹ êµ¬ì¡°ì²´ ì •ì˜í•˜ê¸°**

ë¨¼ì €, survo.c ì— ìƒˆë¡œìš´ ëª¨í„° íƒ€ì…ì˜ ëª…ë ¹ êµ¬ì¡°ì²´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.  
êµ¬ì¡°ì²´ì—ëŠ” **ë°˜ë“œì‹œ `id` í•„ë“œ**ê°€ í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, ëª¨í„°ì˜ ë™ì‘ì— í•„ìš”í•œ ë‹¤ë¥¸ í•„ë“œë¥¼ ì¶”ê°€ë¡œ ì •ì˜í•©ë‹ˆë‹¤.

```c
typedef struct {
    int id;         // ëª¨í„° ê³ ìœ  ID (í•„ìˆ˜ í•„ë“œ)
    int angle;      // ì„œë³´ ëª¨í„° íšŒì „ ê°ë„
    int duration;   // ë™ì‘ ì§€ì† ì‹œê°„ (ms ë‹¨ìœ„)
} ServoMotorCommand;
```

**json ë¬¸ìì—´ì„ êµ¬ì¡°ì²´ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤**
- survo.c ì— ë¬¸ìì—´ì„ êµ¬ì¡°ì²´ë¡œ ë³€ê²½í•˜ëŠ” ë©”ì„œë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
- dc_motor.c íŒŒì¼ì— êµ¬ì¡°ì²´ ë³€ê²½ í•¨ìˆ˜ ì˜ˆì‹œê°€ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤!
```c
void* parse_servo_motor_message(const char* json_str) {
}

```
#### 2. **ëª…ë ¹ ì²˜ë¦¬ í•¨ìˆ˜**ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
- ì•„ë˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.
-  survo.c ì— ëª…ë ¹ ì²˜ë¦¬ ë©”ì„œë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
```c
void handle_servo_motor_command(void* command) {
    ServoMotorCommand* servo_command = (ServoMotorCommand*)command;
    printf("ì„œë³´ ëª¨í„° ì œì–´ - ID: %d, ê°ë„: %d, ì§€ì† ì‹œê°„: %dms\n", 
           servo_command->id, 
           servo_command->angle, 
           servo_command->duration);
}
```
#### 3. **ëª¨í„° í•¸ë“¤ëŸ¬**ë¥¼ í”„ë ˆì„ì›Œí¬ì— ë“±ë¡í•©ë‹ˆë‹¤.
- device_adaptor.c íŒŒì¼ì— í•´ë‹¹ í•¨ìˆ˜ì— ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤

```c
#include "survo.c" // device_adaptor.c íŒŒì¼ì— ì¶”ê°€ 

void register_custom_device_handler() { // êµ¬í˜„ë˜ì–´ ìˆëŠ” í•¨ìˆ˜ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€
    MotorHandler servo_motor_handler = {
        .handle_command = handle_servo_motor_command,
        .parse_message = parse_servo_motor_message,
    };
    register_motor_handler(1, servo_motor_handler); // ëª¨í„° ID 1ì— í•¸ë“¤ëŸ¬ ë“±ë¡
}

}
```

#### ì»´íŒŒì¼

```bash
 gcc -o controller controller.c -lpthread -lwiringPi -ljansson
```

#### ì‹¤í–‰

```bash
gcc -o controller controller.c -lpthread -lwiringPi -ljansson
gcc -o handler handler.c -lpthread -lwiringPi -ljansson
sudo ./main
```

### ğŸ‘¬íŒ€ì› ì†Œê°œ ë° ì—­í• 

<div align="center">
  <table>
    <tr>
      <th>Profile</th>
      <th>Role</th>
    </tr>
    <tr>
      <td align="center">
        <a href="https://github.com/kang20">
          <img src="https://avatars.githubusercontent.com/u/75325326?v=4" width="100" height="80" alt=""/>
          <br/>
          <sub><b>ê°•ë¯¼ê¸°</b></sub>
        </a>
      </td>
      <td>
        ì „ì²´ì ì¸ í”„ë¡œì íŠ¸ êµ¬ì„± ì„¤ê³„, ì œì–´ ì†Œí”„íŠ¸ì›¨ì–´ì™€ ëª¨í„° ì‚¬ì´ì˜ íŒŒì´í”„ë¼ì¸ ê°œë°œ
      </td>
  </table>
</div>
<br>
